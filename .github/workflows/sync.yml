name: Upstream Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *" # daily at 2am

jobs:
  sync:
    name: Upstream Sync
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          # Use a custom PAT to push to enable triggering on_push workflows:
          # https://github.com/orgs/community/discussions/25702
          token: ${{ secrets.PUSH_TOKEN }}

      - name: Git Config
        run: |
          git config --global user.name github-actions
          git config --global user.email noreply+github-actions@namespacelabs.com

      - name: Sync Git Submodules
        run: |
          git submodule init
          git submodule update --remote --merge

      - name: Commit Changes
        run: |
          git add .
          git commit -m "Sync target upstreams" || echo "Nothing to commit"
          git push origin main
